var x=Object.defineProperty;var f=i=>{throw TypeError(i)};var E=(i,t,e)=>t in i?x(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var a=(i,t,e)=>E(i,typeof t!="symbol"?t+"":t,e),g=(i,t,e)=>t.has(i)||f("Cannot "+e);var C=(i,t,e)=>(g(i,t,"read from private field"),e?e.call(i):t.get(i)),b=(i,t,e)=>t.has(i)?f("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e),v=(i,t,e,s)=>(g(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);import{Q as m}from"./quill.DUNyufj3.js";import"./commonjsHelpers.Cpj98o6Y.js";function H(i,t){let e,s=!1;return()=>{e&&clearTimeout(e),s?e=setTimeout(i,t):(i(),s=!0,setTimeout(()=>s=!1,t))}}const y=()=>Math.random().toString(36).slice(2,8),$=i=>typeof i=="function",L=i=>typeof i=="string",S=m.import("formats/header");class O extends S{static create(t){const e=super.create(t);return e.id=y(),e}}var p;const h=class h{constructor(t,e){a(this,"quill");a(this,"scrollContainerListener",H(this.handleScroll.bind(this),100));a(this,"editorHeaders",[]);a(this,"isHidden",!1);a(this,"bem",((t,e="hl")=>{const s=e?`${e}-`:"";return{b:()=>`${s}${t}`,be:o=>o?`${s}${t}__${o}`:"",bm:o=>o?`${s}${t}--${o}`:"",bem:(o,n)=>o&&n?`${s}${t}__${o}--${n}`:"",ns:o=>o?`${s}${o}`:"",bs:o=>o?`${s}${t}-${o}`:"",cv:o=>o?`--${s}${o}`:"",is:o=>`is-${o}`}})("header-list"));a(this,"root");a(this,"options");a(this,"highlightedItem");b(this,p,0);this.quill=t,this.options=this.resolveOptions({...e}),this.options.container?(this.hide(),this.root=this.buildList(),this.options.container.appendChild(this.root),this.quill.on(m.events.TEXT_CHANGE,H(()=>this.updateHeaders(),500)),this.quill.on(m.events.EDITOR_CHANGE,()=>{const[s]=this.quill.selection.getRange();s===null&&this.activeToolbarControl()})):console.warn("header-list: options.container is required")}static register(){m.import("ui/icons")[h.toolName]='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M19.6 2H8.4A2.4 2.4 0 0 0 6 4.4v11.2A2.4 2.4 0 0 0 8.4 18h11.2a2.4 2.4 0 0 0 2.4-2.4V4.4A2.4 2.4 0 0 0 19.6 2M9 7a1 1 0 0 1 1-1h8a1 1 0 1 1 0 2h-8a1 1 0 0 1-1-1m1 2a1 1 0 0 0 0 2h8a1 1 0 1 0 0-2zm-1 4a1 1 0 0 1 1-1h4a1 1 0 1 1 0 2h-4a1 1 0 0 1-1-1" clip-rule="evenodd"/><path fill="currentColor" d="M4 4a1 1 0 0 0-2 0v11.6C2 19.132 4.868 22 8.4 22H20a1 1 0 1 0 0-2H8.4A4.403 4.403 0 0 1 4 15.6z"/></svg>';const t=function(e){return class extends e{static create(s){const o=super.create(s);return o.id=y(),o}}}(m.import("formats/header"));m.register({"formats/header":t},!0)}resolveOptions(t){const e=L(t.container)?document.getElementById(t.container):t.container;let s,o=t.scrollContainer?L(t.scrollContainer)?document.getElementById(t.scrollContainer):t.scrollContainer:this.quill.root;o!==window&&o!==document.documentElement||(o=void 0);const n=t.topOffset;return $(n)?s=n:s=typeof n=="number"?()=>n:()=>0,Object.assign({hideClass:this.bem.is("hidden"),headerHeight:36,onBeforeShow:()=>!1,onBeforeHide:()=>!1,onItemClick:()=>{},container:e},{...t},{scrollContainer:o,topOffset:async()=>{let r=await s();return r=Number.isNaN(Number(r))?0:r,C(this,p)!==r&&v(this,p,r),r}})}updateHeaders(){const t=Array.from(this.quill.root.querySelectorAll(":scope > h1, :scope > h2, :scope > h3, :scope > h4, :scope > h5, :scope > h6")),e=this.editorHeaders.map(n=>n.el).filter(n=>!t.includes(n)),s=[],o=[];for(const[n,r]of t.entries())this.editorHeaders.some(c=>c.el===r)?this.editorHeaders.some(({el:c,text:d})=>c===r&&d!==r.textContent)&&o.push(r):s.push({el:r,index:n});this.update(s,e,o),this.editorHeaders=t.map(n=>({el:n,text:n.textContent||""}))}bindScrollListener(){let t=window;this.options.scrollContainer&&(t=this.options.scrollContainer),t.addEventListener("scroll",this.scrollContainerListener)}removeScrollListener(){let t=window;this.options.scrollContainer&&(t=this.options.scrollContainer),t.removeEventListener("scroll",this.scrollContainerListener)}async handleScroll(){var c,d;if(!this.root)return;let t=((c=this.editorHeaders[0])==null?void 0:c.el)||null;const e=this.options.scrollContainer||document.documentElement,s=await this.options.topOffset(),o=e.scrollTop,n=((d=this.options.scrollContainer)==null?void 0:d.offsetParent)||document.body,r=this.editorHeaders.map(({el:l})=>({el:l,top:T(l,n)})).filter(({top:l})=>!Number.isNaN(l)).sort((l,u)=>l.top-u.top);for(const{el:l,top:u}of r){if(u>o+s+this.options.headerHeight)break;t=l}t&&this.setHighlight(t.id)}buildList(){const t=document.createElement("div");return t.classList.add(this.bem.b()),t}createListItem(t,e,s){const o=document.createElement("div");return o.classList.add(this.bem.be("item"),`level-${s}`),o.dataset.id=t,o.textContent=e,o}async hide(){await this.options.onBeforeHide()||(this.options.container.classList.add(this.options.hideClass),this.isHidden=!0,this.activeToolbarControl(),this.removeScrollListener())}async show(){await this.options.onBeforeShow()||(this.options.container.classList.remove(this.options.hideClass),this.isHidden=!1,this.activeToolbarControl(),this.handleScroll(),this.bindScrollListener())}activeToolbarControl(){const t=this.quill.getModule("toolbar");if(!t)return;const e=t.controls.find(([s])=>s===h.toolName);e&&(this.isHidden?e[1].classList.remove("ql-active"):e[1].classList.add("ql-active"))}toggleDisplay(){return this.isHidden?this.show():this.hide()}update(t,e,s){if(this.root){for(const o of e){const n=this.root.querySelector(`[data-id="${o.id}"]`);n&&n.remove()}for(const{index:o,el:n}of t)this.root.insertBefore(this.createListItem(n.id,n.textContent||"",Number(n.tagName.slice(1))),this.root.children[o]);this.root.addEventListener("click",async o=>{const n=o.target;if(!n||!n.classList.contains(this.bem.be("item")))return;const r=n.dataset.id;if(!r)return;const c=["h1","h2","h3","h4","h5","h6"].map(l=>`:scope > ${l}[id="${r}"]`).join(", "),d=this.quill.root.querySelector(c);if(d){const l=this.options.scrollContainer||document.documentElement;let u=0;l===document.documentElement&&(u=this.quill.root.getBoundingClientRect().top+window.scrollY);const q=await this.options.topOffset(),N=u+d.offsetTop-q;l.scrollTo({top:N})}$(this.options.onItemClick)&&this.options.onItemClick(r)});for(const o of s){const n=this.root.querySelector(`[data-id="${o.id}"]`);n&&(n.textContent=o.textContent)}}}setHighlight(t){if(!this.root)return;const e=this.root.querySelector(`:scope > [data-id="${t}"]`);e&&(this.highlightedItem&&this.highlightedItem.classList.remove(this.bem.is("highlight")),e.classList.add(this.bem.is("highlight")),this.highlightedItem=e)}};p=new WeakMap,a(h,"moduleName","header-list"),a(h,"toolName","header-list"),a(h,"toolbarHandle",async function(){const t=this.quill.getModule(h.moduleName);t&&t.toggleDisplay()});let w=h;function T(i,t=document.body){let e=0;for(;i!==t;){if(i===null)return Number.NaN;e+=i.offsetTop,i=i.offsetParent}return e}export{w as HeaderList,O as HeaderWithID,w as default};
